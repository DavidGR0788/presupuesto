{% extends "base.html" %}

{% block title %}Dashboard - Presupuesto Personal{% endblock %}

{% block content %}
<!-- Header Simple -->
<div class="content-header">
    <h1 class="h2 mb-3">
        <i class="fas fa-tachometer-alt me-2"></i>
        Panel de Control
    </h1>
    <div class="month-selector">
        <span class="badge bg-secondary fs-6">
            {{ now.day }} / {{ now.strftime('%b').upper() }} / {{ now.year }}
        </span>
    </div>
</div>

<!-- Primera Fila: Tarjetas de Resumen -->
<div class="row mb-4">
    <!-- Ingresos Totales -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card income-card text-white shadow h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">INGRESOS TOTALES</div>
                        <div class="h5 mb-0 font-weight-bold">${{ "{:,.0f}".format(total_ingresos) }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-money-bill-wave fa-2x text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gastos Totales -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card expense-card text-white shadow h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">GASTOS TOTALES</div>
                        <div class="h5 mb-0 font-weight-bold">${{ "{:,.0f}".format(total_gastos) }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-receipt fa-2x text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Saldo Actual -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card balance-card text-white shadow h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">SALDO ACTUAL</div>
                        <div class="h5 mb-0 font-weight-bold">${{ "{:,.0f}".format(saldo) }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-balance-scale fa-2x text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ahorros - Meta -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card savings-card text-white shadow h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">MIS AHORROS</div>
                        
                        <!-- Barra de Progreso de Ahorros -->
                        {% if total_ahorros and meta_ahorros and meta_ahorros > 0 %}
                            {% set progreso_ahorros = (total_ahorros / meta_ahorros * 100) %}
                            {% set progreso_ahorros = progreso_ahorros|round|int %}
                        {% else %}
                            {% set progreso_ahorros = 0 %}
                        {% endif %}
                        
                        <div class="progress mb-2" style="height: 20px; background-color: rgba(255,255,255,0.3);">
                            <div class="progress-bar bg-white" 
                                 role="progressbar" 
                                 style="width: {{ progreso_ahorros }}%; color: #f59e0b;"
                                 aria-valuenow="{{ progreso_ahorros }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                {% if progreso_ahorros > 15 %}{{ progreso_ahorros }}%{% endif %}
                            </div>
                        </div>
                        
                        <div class="h6 mb-0 font-weight-bold">
                            ${{ "{:,.0f}".format(total_ahorros or 0) }} 
                            {% if meta_ahorros and meta_ahorros > 0 %}
                                / ${{ "{:,.0f}".format(meta_ahorros) }}
                            {% endif %}
                        </div>
                        <small class="text-white-50">
                            {% if meta_ahorros and meta_ahorros > 0 %}
                                {{ "¬°Meta de ahorros alcanzada! üéâ" if total_ahorros >= meta_ahorros else "Progreso de ahorros" }}
                            {% else %}
                                Configura tu meta de ahorros
                            {% endif %}
                        </small>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-piggy-bank fa-2x text-white-50 piggy-icon"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Segunda Fila: √öltimos Ingresos y Gastos -->
<div class="row">
    <!-- √öltimos Ingresos -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow h-100">
            <div class="card-header py-3 text-white" style="background: linear-gradient(135deg, #10b981, #059669);">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-money-bill-wave me-2"></i>
                    √öltimos Ingresos
                </h6>
            </div>
            <div class="card-body">
                {% if ultimos_ingresos %}
                    <div class="list-group list-group-flush transaction-list">
                        {% for income in ultimos_ingresos %}
                        <div class="list-group-item d-flex justify-content-between align-items-center fade-in" 
                             data-transaction-id="{{ income.id }}">
                            <div>
                                <h6 class="mb-1">{{ income.concepto }}</h6>
                                <small class="text-muted">
                                    {{ income.fecha.strftime('%d/%m/%Y') if income.fecha else '' }}
                                    ‚Ä¢ 
                                    <span class="badge" style="background-color: {{ income.color }}; color: white;">
                                        {{ income.icono }} {{ income.categoria_nombre }}
                                    </span>
                                </small>
                            </div>
                            <span class="badge bg-success rounded-pill">${{ "{:,.0f}".format(income.monto) }}</span>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4 empty-state">
                        <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
                        <p>No hay ingresos registrados</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- √öltimos Gastos -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow h-100">
            <div class="card-header py-3 text-white" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-receipt me-2"></i>
                    √öltimos Gastos
                </h6>
            </div>
            <div class="card-body">
                {% if ultimos_gastos %}
                    <div class="list-group list-group-flush transaction-list">
                        {% for expense in ultimos_gastos %}
                        <div class="list-group-item d-flex justify-content-between align-items-center fade-in" 
                             data-transaction-id="{{ expense.id }}">
                            <div>
                                <h6 class="mb-1">{{ expense.concepto }}</h6>
                                <small class="text-muted">
                                    {{ expense.fecha.strftime('%d/%m/%Y') if expense.fecha else '' }}
                                    ‚Ä¢ 
                                    <span class="badge" style="background-color: {{ expense.color }}; color: white;">
                                        {{ expense.icono }} {{ expense.categoria_nombre }}
                                    </span>
                                </small>
                            </div>
                            <span class="badge bg-danger rounded-pill">${{ "{:,.0f}".format(expense.monto) }}</span>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4 empty-state">
                        <i class="fas fa-receipt fa-2x mb-2"></i>
                        <p>No hay gastos registrados</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Tercera Fila: Metas de Ahorro y Acciones R√°pidas -->
{% if metas_activas %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3 text-white" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-bullseye me-2"></i>
                    Metas de Ahorro Activas
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for meta in metas_activas %}
                    <div class="col-md-4 mb-3">
                        <div class="card border-warning fade-in">
                            <div class="card-body">
                                <h6 class="card-title">{{ meta.concepto }}</h6>
                                <div class="progress mb-2" style="height: 15px;">
                                    <div class="progress-bar bg-warning" 
                                         style="width: {{ meta.porcentaje_completado }}%;">
                                        {{ meta.porcentaje_completado|round|int }}%
                                    </div>
                                </div>
                                <p class="card-text small mb-1">
                                    <strong>${{ "{:,.0f}".format(meta.ahorrado_actual) }}</strong> 
                                    de ${{ "{:,.0f}".format(meta.meta_total) }}
                                </p>
                                {% if meta.fecha_objetivo %}
                                <p class="card-text small text-muted mb-0">
                                    Objetivo: {{ meta.fecha_objetivo.strftime('%d/%m/%Y') }}
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Quick Actions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3 text-white" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-bolt me-2"></i>
                    Acciones R√°pidas
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('income.index') }}" class="btn btn-success w-100">
                            <i class="fas fa-plus-circle me-2"></i>
                            Agregar Ingreso
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('expenses.index') }}" class="btn btn-danger w-100">
                            <i class="fas fa-minus-circle me-2"></i>
                            Agregar Gasto
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('budgets.index') }}" class="btn btn-primary w-100">
                            <i class="fas fa-chart-pie me-2"></i>
                            Ver Presupuestos
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('savings.index') }}" class="btn btn-warning w-100">
                            <i class="fas fa-piggy-bank me-2"></i>
                            Mis Ahorros
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CSS Adicional -->
<style>
/* Header */
.content-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    border-radius: 10px;
    padding: 1rem 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Ajuste del logo del marranito - MEJOR ALINEACI√ìN */
.piggy-icon {
    transform: translateY(-12px) !important;
    position: relative;
}

/* Ajustar el contenedor del icono para mejor alineaci√≥n */
.savings-card .col-auto {
    display: flex;
    align-items: flex-start;
    justify-content: center;
    height: 100%;
}

/* Progress Bars */
.progress {
    border-radius: 10px;
    overflow: hidden;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
}

.progress-bar {
    transition: width 0.6s ease;
    font-weight: bold;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Tarjetas */
.card {
    border: none;
    border-radius: 15px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

/* Asegurar que todos los iconos tengan la misma alineaci√≥n */
.income-card .col-auto,
.expense-card .col-auto,
.balance-card .col-auto,
.savings-card .col-auto {
    display: flex;
    align-items: center;
    justify-content: center;
}

/* ANIMACIONES PARA TRANSACCIONES - NUEVO */
.fade-in {
    animation: fadeInUp 0.5s ease-out;
}

.slide-out {
    animation: slideOutRight 0.3s ease-in forwards;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideOutRight {
    from {
        opacity: 1;
        transform: translateX(0);
        max-height: 100px;
    }
    to {
        opacity: 0;
        transform: translateX(100%);
        max-height: 0;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }
}

/* Animaci√≥n para las tarjetas al cargar */
.card {
    animation: cardFadeIn 0.6s ease-out;
}

@keyframes cardFadeIn {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Animaci√≥n escalonada para items de lista */
.list-group-item {
    animation-duration: 0.5s;
    animation-fill-mode: both;
}

.list-group-item:nth-child(1) { animation-delay: 0.1s; }
.list-group-item:nth-child(2) { animation-delay: 0.2s; }
.list-group-item:nth-child(3) { animation-delay: 0.3s; }
.list-group-item:nth-child(4) { animation-delay: 0.4s; }
.list-group-item:nth-child(5) { animation-delay: 0.5s; }

/* Transici√≥n suave para hover en botones */
.btn {
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Responsive */
@media (max-width: 768px) {
    .content-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .piggy-icon {
        transform: translateY(-8px) !important;
    }
}
</style>

<!-- JavaScript para animaciones -->
<script>
// Animaci√≥n para elementos al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Aplicar animaci√≥n fade-in a todos los elementos con la clase
    const animatedElements = document.querySelectorAll('.fade-in');
    animatedElements.forEach((element, index) => {
        element.style.animationDelay = `${index * 0.1}s`;
    });
});

// Funci√≥n para animar eliminaci√≥n de transacciones
function animateRemoveTransaction(element) {
    element.classList.add('slide-out');
    setTimeout(() => {
        element.remove();
    }, 300);
}

// Ejemplo de uso para futuras implementaciones con AJAX
function addNewTransaction(transactionData, container) {
    const newElement = document.createElement('div');
    newElement.className = 'list-group-item d-flex justify-content-between align-items-center fade-in';
    newElement.innerHTML = `
        <div>
            <h6 class="mb-1">${transactionData.concepto}</h6>
            <small class="text-muted">
                ${transactionData.fecha} ‚Ä¢ 
                <span class="badge" style="background-color: ${transactionData.color}; color: white;">
                    ${transactionData.icono} ${transactionData.categoria}
                </span>
            </small>
        </div>
        <span class="badge ${transactionData.tipo === 'ingreso' ? 'bg-success' : 'bg-danger'} rounded-pill">
            $${transactionData.monto}
        </span>
    `;
    
    container.prepend(newElement);
}
</script>
{% endblock %}